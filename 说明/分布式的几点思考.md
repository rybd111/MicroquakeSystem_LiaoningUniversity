#<center>分布式的几点思考</center>#
#### 鉴于目前的后台程序运行时出现的由于各个测点网络带宽低、数据传输延迟高、无法满足监测生产任务的问题，近期通过与组内各位零星的讨论对后台程序作出以下几点思考。 ####

----------

>波形数据存储格式与波形数据的相应格式的读取方法（write）（当波形在各个测点上被存储时，波形应存储为二进制格式，比如python的numpy包给定的npz格式，可以缓解各测点的存储压力，在汇总时，再解析为正常格式，方便放入方法中进行存储。但验证只是读取快100倍，文件大小并没有减小，因此此种方式不适用。

   **提示：earthquake类中，写入数据应包含（数据容器内的所有数据+激发位置（getlineSeriesNew（））+传感器对应的盘符名称，的形式存储）**

----------

>激发数据记录拽取（pull）与cs端显示（将所有台站对应的激发记录（有固定目录，近10分钟的）汇总、可以先随机生成一些记录，记录格式如图1所示；考虑到远端程序还没部署，没有真实数据；显示在中心机cs端，此时波形文件未拽取，拉取的记录数据发送给激发数据记录匹配）

   **提示：cs端显示时，在菜单栏中单独写一个“分布式工作状态监控”按钮，在新界面可以显示当前拉取的数据，每隔5分钟或10分钟拉取一次，发送给激发数据记录匹配模块，进行记录的匹配。当前拉取的记录可以临时放入文件中缓存，否则当中心机死机时，后续环节可能出现问题。**

   ![各测点记录](C:/Users/Administrator/Desktop/records.png)
<center>图1 记录格式，其中第一列为时间戳，第二列为s盘符，第三列为文件路径，第四列为初动极值。</center>
    
----------

> 激发数据记录匹配（match）（将所有台站10分钟内的激发记录进行事件认定，在同一秒内的记录抽取至队列，队列中每个元素应当是一个字符串数组，并最后将队列发送给波形数据拽取与汇总）
     
   **提示：按照罗老师的观点，在2秒内的记录被认为是同一个事件，在匹配时，比对时间戳即可。**

----------

> 波形数据拽取与汇总（gather）（将所有台站匹配得到的被认定为是同一个事件的记录，所对应的波形文件拉取至中心机，汇总、计算时空强，存储到数据库，相当于原来的计算模块不使用30s数据，而是直接使用激发数据记录中的数据项和波形文件进行时空强的计算。并在汇总后删除没有匹配上的远端测点波形文件，减少硬盘空间的占用）  
     
   **提示：拽取波形可以考虑使用采用FTP协议的传输机制，可能有现成的jar包，这样可以在网络时断时续的情况下，继续完成波形数据的传输，保证数据传输的稳定性。**

----------

> 分布式通信机制的优化（distribution）（当中心机宕机或因网络故障无法与各测点通信时，各测点应能互相通信，以完成基本的数据收集工作，因此考虑采用星型+环状的混合网络拓补结构，当某个节点宕机时，其他节点应能互相通信）。

   **提示：当中心机无法联网或宕机时，中心机的计算无法进行，各测点继续按照激发判断保存波形与激发数据记录，但我们能否考虑在中心机无法计算的情况下，继续进行边缘计算，能够在没有中心机的情况下继续进行计算？首先需要监测中心机是否断线，然后当中心机断线时，将其中一个测点作为波形的汇总和激发数据记录的汇总点，存储这些记录，但不进行计算。此部分单独写程序实现还是放在现有程序中，采用监控类的形式，均可，但如果拆开写，需要后台有个响应机制，调整当前的运行策略，需要进一步讨论确定。**

----------

> 波形数据查询（在cs端新建拉取界面，给定一个时刻，将该时刻发送给所有能够正常通信的测点，在remote程序中加入新线程，按照给定时刻首先查找对应的原始文件，读取原始文件，拉取至中心机，该线程结束），该步骤是为了查询具体时间的数据，以便后续加入未激发传感器截取波形的功能实现，以及在后续对分布式通信机制进行优化时，在没有中心机的前提下，各个测点可以不用通过中心机进行记录的匹配和计算。

   **提示：波形数据查询，相当于给定时间戳，查找时间戳附近的波形，将其直接拉回中心机进行查看，格式与现有波形文件csv格式一致。**2020-12-1 10：08：08

   **可以先进行时间戳所在原始文件的数据读取，因为直接查询波形还是很慢的一个过程，取决于那个测点的网速，因此对系统的性能影响较大，若拷贝文件，可以实现拷贝过程的透明性，使用Windows文件系统，不占用系统内资源。**12/8/2020 12:16:30 PM

